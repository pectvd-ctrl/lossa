<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AccÃ¨s WiFi</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <main class="container">
    <section class="card">

      <h2>AccÃ¨s WiFi sÃ©curisÃ©</h2>
      <p>Entrez le code pour accÃ©der au WiFi.</p>

      <div id="user-info" class="hidden">
        <p id="user-email" class="email"></p>
      </div>

      <div class="input-wrap">
        <input type="password" id="wifiCode" class="input" placeholder="Entrez le code">
        <span id="togglePassword" class="toggle-eye">ğŸ‘ï¸</span>
      </div>

      <button id="validateBtn" class="btn btn-primary">Valider</button>

      <p id="error" class="error hidden"></p>

    </section>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

// -------------------------
// ğŸ”¹ Configuration Firebase
// -------------------------
const firebaseConfig = {
  apiKey: "AIzaSyDLZZyoiHysKOL1XwnOUV2-QhdSsZZCHbs",
  authDomain: "lossa-b3-11.firebaseapp.com",
  projectId: "lossa-b3-11",
  storageBucket: "lossa-b3-11.firebasestorage.app",
  messagingSenderId: "637445869503",
  appId: "1:637445869503:web:3948cb73f023a753e29b0a",
  measurementId: "G-4720V8DGPK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// -------------------------
// ğŸ”¹ Variables DOM
// -------------------------
const codeInput = document.getElementById("wifiCode");
const validateBtn = document.getElementById("validateBtn");
const errorBox = document.getElementById("error");
const userEmailElement = document.getElementById("user-email");
const userInfo = document.getElementById("user-info");

// -------------------------
// ğŸ”¹ Lecture des paramÃ¨tres CoovaChilli
// -------------------------
const params = new URLSearchParams(window.location.search);
const uamip = params.get("uamip") || "";
const uamport = params.get("uamport") || "";
const challenge = params.get("challenge") || "";
const userurl = params.get("userurl") || "";

// -------------------------
// ğŸ”¹ VÃ©rifier si l'utilisateur est connectÃ© Ã  Firebase
// -------------------------
onAuthStateChanged(auth, user => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }
  userEmailElement.textContent = "Utilisateur : " + user.email;
  userInfo.classList.remove("hidden");
});

// -------------------------
// ğŸ”¹ Validation du code WiFi
// -------------------------
validateBtn.addEventListener("click", async () => {
  const codeEntered = codeInput.value.trim();
  console.log("ğŸŸ¡ Code saisi par lâ€™utilisateur :", codeEntered);

  try {
    console.log("ğŸ“¡ Lecture du document Firestore...");
    const docRef = doc(db, "user", "lossa");
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      console.warn("âš ï¸ Document Firestore introuvable !");
      errorBox.textContent = "Erreur : code introuvable";
      errorBox.classList.remove("hidden");
      return;
    }

    const data = docSnap.data();
    const correctCode = String(data.codax || "").trim();
    console.log("ğŸ“˜ Code enregistrÃ© dans Firestore :", correctCode);

    // Comparaison du code entrÃ© et du code Firestore
    if (codeEntered === correctCode) {
      console.log("âœ… Code correct ! VÃ©rification des paramÃ¨tres CoovaChilli...");

      // Affiche les variables CoovaChilli
      console.log("ğŸŒ uamip :", uamip);
      console.log("ğŸŒ uamport :", uamport);
      console.log("ğŸŒ challenge :", challenge);
      console.log("ğŸŒ userurl :", userurl);

      if (uamip && uamport) {
        const logonUrl = `http://${uamip}:${uamport}/logon?username=${encodeURIComponent(codeEntered)}&password=${encodeURIComponent(codeEntered)}&challenge=${encodeURIComponent(challenge)}&userurl=${encodeURIComponent(userurl)}`;
        console.log("ğŸš€ Envoi de la requÃªte Ã  CoovaChilli :", logonUrl);
        window.location.href = logonUrl;
      } else {
        console.warn("âš ï¸ CoovaChilli non dÃ©tectÃ© â€” mode test actif.");
        errorBox.textContent = "âœ… Code correct (mode test, pas de CoovaChilli dÃ©tectÃ©)";
        errorBox.classList.remove("hidden");
      }
    } else {
      console.warn("âŒ Code incorrect !");
      errorBox.textContent = "Code incorrect";
      errorBox.classList.remove("hidden");
    }

  } catch (error) {
    console.error("ğŸ’¥ Erreur lors de la validation :", error);
    errorBox.textContent = "Erreur serveur, rÃ©essayez plus tard";
    errorBox.classList.remove("hidden");
  }
});


// -------------------------
// ğŸ”¹ Afficher / masquer le code
// -------------------------
const togglePassword = document.getElementById("togglePassword");
togglePassword.addEventListener("click", () => {
  if (codeInput.type === "password") {
    codeInput.type = "text";
    togglePassword.textContent = "ğŸ™ˆ";
  } else {
    codeInput.type = "password";
    togglePassword.textContent = "ğŸ‘ï¸";
  }
});
</script>




</body>
</html>
