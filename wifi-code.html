<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AccÃ¨s WiFi</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <main class="container">
    <section class="card">

      <h2>AccÃ¨s WiFi sÃ©curisÃ©</h2>
      <p>Entrez le code pour accÃ©der au WiFi.</p>

      <div id="user-info" class="hidden">
        <p id="user-email" class="email"></p>
      </div>

      <div class="input-wrap">
        <input type="password" id="wifiCode" class="input" placeholder="Entrez le code">
        <span id="togglePassword" class="toggle-eye">ğŸ‘ï¸</span>
      </div>

      <button id="validateBtn" class="btn btn-primary">Valider</button>

      <p id="error" class="error hidden"></p>

    </section>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDLZZyoiHysKOL1XwnOUV2-QhdSsZZCHbs",
  authDomain: "lossa-b3-11.firebaseapp.com",
  projectId: "lossa-b3-11",
  storageBucket: "lossa-b3-11.firebasestorage.app",
  messagingSenderId: "637445869503",
  appId: "1:637445869503:web:3948cb73f023a753e29b0a",
  measurementId: "G-4720V8DGPK"
};

console.log("Initialisation Firebase...");
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const codeInput = document.getElementById("wifiCode");
const validateBtn = document.getElementById("validateBtn");
const errorBox = document.getElementById("error");
const userEmailElement = document.getElementById("user-email");
const userInfo = document.getElementById("user-info");

// VÃ©rifier si l'utilisateur est connectÃ©
console.log("VÃ©rification de l'utilisateur connectÃ©...");
onAuthStateChanged(auth, user => {
  if (!user) {
    console.warn("Aucun utilisateur connectÃ©, redirection...");
    window.location.href = "index.html";
    return;
  }
  console.log("Utilisateur connectÃ© :", user.email, "| UID :", user.uid);
  userEmailElement.textContent = "Utilisateur: " + user.email;
  userInfo.classList.remove("hidden");
});

// VÃ©rification du code WiFi depuis Firestore
validateBtn.addEventListener("click", async () => {
  const codeEntered = codeInput.value.trim();
  console.log("Bouton Valider cliquÃ©. Code saisi :", codeEntered);

  try {
    console.log("RÃ©cupÃ©ration du document Firestore...");
    const docRef = doc(db, "user", "lossa"); // document contenant le code
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      console.error("Document introuvable !");
      errorBox.textContent = "Erreur : code introuvable";
      errorBox.classList.remove("hidden");
      return;
    }

    console.log("Document trouvÃ© :", docSnap.data());

    const data = docSnap.data();

    if (!data.codax) {
      console.error("Champ 'codax' manquant dans le document !");
      errorBox.textContent = "Erreur : code non dÃ©fini";
      errorBox.classList.remove("hidden");
      return;
    }

    const correctCode = String(data.codax).trim(); // AccÃ¨s au nouveau champ
    console.log("Code Firestore :", correctCode, "| Type :", typeof correctCode);

    if (codeEntered === correctCode) {
      console.log("Code correct ! Redirection vers wifi-final.html...");
      window.location.href = "wifi-final.html";
    } else {
      console.warn("Code incorrect !");
      errorBox.textContent = "Code incorrect";
      errorBox.classList.remove("hidden");
    }

  } catch (error) {
    console.error("Erreur lecture Firestore :", error);
    errorBox.textContent = "Erreur serveur, rÃ©essayez plus tard";
    errorBox.classList.remove("hidden");
  }
});

// Afficher / masquer le code
const togglePassword = document.getElementById("togglePassword");
togglePassword.addEventListener("click", () => {
  console.log("Toggle Password cliquÃ©. Type actuel :", codeInput.type);
  if (codeInput.type === "password") {
    codeInput.type = "text";
    togglePassword.textContent = "ğŸ™ˆ";
    console.log("Code visible");
  } else {
    codeInput.type = "password";
    togglePassword.textContent = "ğŸ‘ï¸";
    console.log("Code masquÃ©");
  }
});
</script>



</body>
</html>
